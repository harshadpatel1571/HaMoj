@model Hamoj.Service.Dto.CustomerDto;
@{
    Layout = "~/Views/Shared/_Vendor.cshtml";
    ViewData["Title"] = "Vendor Report";
}

<partial name="~/Views/Shared/_Breadcrumb.cshtml" />
<div class="card">
    <div class="card-header">
        <h4 class="card-title">Vendor Report</h4>
    </div>
    <div class="card-body">
        <div class="basic-form">
            <form method="post" asp-action="">
                <div class="row">
                    <div class="mb-3 col-md-3">
                        <label class="form-label">Customer</label>
                        <select class="default-select form-control wide" asp-for="CompanyName" asp-items="@ViewBag.CustomerList" id="SelectCustomer">
                            <option value="0">Select Customer</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fromDate" class="form-label">From Date</label>
                        <input type="date" id="fromDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label for="toDate" class="form-label">To Date</label>
                        <input type="date" id="toDate" class="form-control">
                    </div>
                    <div class="col-md-3" style="margin-top:30px">
                        <button id="btnSearch" type="button" class="btn btn-primary">Search</button>
                    </div>
                    <div class="col-md-5" id="totalAmount">
                        <label for="" class="form-label">Total Amount</label>
                        <input type="text" class="form-control" id="grandTotal" readonly>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
<div class="card">
    <div class="card-body" id="table">
        <div class="table-responsive">
            <table id="dataTable" class="display" style="min-width: 845px">
                <thead>
                    <tr>
                        <th>Customer Name</th>
                        <th>Month</th>
                        <th>Panding Payment</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $("#totalAmount").hide();
        $("#btnPaid").hide();
        $("#table").hide();

        $("#btnSearch").click(function () {
            var customer = $("#SelectCustomer").val();
            var fromDate = $("#fromDate").val();
            var toDate = $("#toDate").val();
            var totalGrandTotal = 0;
            $.ajax({
                url: `/VendorReport/BindData`,
                type: 'POST',
                data: { customer: customer, fromDate: fromDate, toDate: toDate },
                success: function (result) {
                    $("#dataTable tbody").empty();
                    $.each(result.data, function (index, value) {
                        $("#table").show();
                        console.log(result.data);
                        var row = $("<tr></tr>");

                        row.append($("<td></td>").text(value.customerDto.name));
                        row.append($("<td></td>").text(value.month));
                        row.append($("<td></td>").text(value.grandTotal));

                        var paidButton = $("<button></button>")
                            .text("Paid Now").addClass("btn btn-primary mb-3")
                            .attr("data-id", value.customerDto.id);

                        row.append($("<td></td>").append(paidButton));
                        paidButton.on("click", function () {
                            Swal.fire({
                                title: "Are you sure?",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonColor: "#3085d6",
                                cancelButtonColor: '#d33',
                                confirmButtonText: "Yes !",
                                cancelButtonText: "cancel!",
                                closeOnConfirm: false
                            }).then((result) => {
                                if (result.isConfirmed) {   
                                    var customerId = $("#SelectCustomer").val();
                                    var fromDate = $("#fromDate").val();
                                    var toDate = $("#toDate").val();
                                    $.ajax({
                                        url: `/VendorReport/UpdateStatus`,
                                        type: 'POST',
                                        data: { customerId: customerId, fromDate: fromDate, toDate: toDate },
                                        success: function (response) {
                                            window.location.reload();
                                        },
                                        error: function (xhr, status, error) {
                                            console.log("Error:", error);
                                        }
                                    });
                                }
                            });
                           
                        });

                        $("#dataTable tbody").append(row);

                    });

                }
            });
        });
    </script>
}
